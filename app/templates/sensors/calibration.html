{% extends 'base.html' %}

{% block title %}Sensor Calibration{% endblock %}

{% block page_title %}Sensor Calibration{% endblock %}

{% block content %}
<div class="container-fluid calibration-container">
    <div class="section-header">
        <h3><i class="fas fa-sliders-h"></i> Sensor Calibration</h3>
        <button id="refresh-readings" class="refresh-btn" title="Refresh readings">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>

    <div class="row sensor-calibration-grid">
        <!-- pH Calibration -->
        <div class="col-12 col-md-6 col-lg-4 mb-4">
            <div class="calibration-card">
                <div class="card-header">
                    <h4><i class="fas fa-flask"></i> pH Sensor Calibration</h4>
                    <div class="current-reading">
                        <span class="label">Current:</span>
                        <span class="value" id="current-ph">Loading...</span>
                    </div>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('sensors.calibrate_ph_sensor') }}" method="post" class="calibration-form">
                        <div class="form-group mb-3">
                            <label for="ph-calibration-point">Calibration Point:</label>
                            <select name="point" id="ph-calibration-point" class="form-select" required>
                                <option value="">Select a calibration point</option>
                                <option value="low">Low (pH 4.0)</option>
                                <option value="mid">Mid (pH 7.0)</option>
                                <option value="high">High (pH 10.0)</option>
                            </select>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="ph-calibration-value">Actual Value:</label>
                            <input type="number" name="value" id="ph-calibration-value" class="form-control" step="0.01" min="0" max="14" placeholder="e.g. 4.0" required>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Calibrate pH</button>
                        </div>
                    </form>
                    
                    <div class="calibration-instructions">
                        <p><strong>Note:</strong> For best results, calibrate with at least two points. Use standard pH buffer solutions.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- EC Calibration -->
        <div class="col-12 col-md-6 col-lg-4 mb-4">
            <div class="calibration-card">
                <div class="card-header">
                    <h4><i class="fas fa-bolt"></i> EC Sensor Calibration</h4>
                    <div class="current-reading">
                        <span class="label">Current:</span>
                        <span class="value" id="current-ec">Loading...</span>
                    </div>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('sensors.calibrate_ec_sensor') }}" method="post" class="calibration-form">
                        <div class="form-group mb-3">
                            <label for="ec-calibration-point">Calibration Point:</label>
                            <select name="point" id="ec-calibration-point" class="form-select" required>
                                <option value="">Select a calibration point</option>
                                <option value="low">Low (1413 μS/cm)</option>
                                <option value="high">High (2764 μS/cm)</option>
                            </select>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="ec-calibration-value">Actual Value (μS/cm):</label>
                            <input type="number" name="value" id="ec-calibration-value" class="form-control" step="1" min="0" max="5000" placeholder="e.g. 1413" required>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Calibrate EC</button>
                        </div>
                    </form>
                    
                    <div class="calibration-instructions">
                        <p><strong>Note:</strong> Use standard EC calibration solutions. Make sure the probe is clean and dry before calibration.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Temperature Calibration -->
        <div class="col-12 col-md-6 col-lg-4 mb-4">
            <div class="calibration-card">
                <div class="card-header">
                    <h4><i class="fas fa-thermometer-half"></i> Temperature Sensor Calibration</h4>
                    <div class="current-reading">
                        <span class="label">Current:</span>
                        <span class="value" id="current-temp">Loading...</span>
                    </div>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('sensors.calibrate_temp_sensor') }}" method="post" class="calibration-form">
                        <div class="form-group mb-3">
                            <label for="temp-calibration-value">Actual Temperature (°C):</label>
                            <input type="number" name="value" id="temp-calibration-value" class="form-control" step="0.1" min="0" max="50" placeholder="e.g. 25.0" required>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Calibrate Temperature</button>
                        </div>
                    </form>
                    
                    <div class="calibration-instructions">
                        <p><strong>Note:</strong> Use a reliable reference thermometer for accurate calibration.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .calibration-container {
        padding: var(--spacing-md);
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: var(--spacing-sm);
    }
    
    .section-header h3 {
        margin: 0;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
    }
    
    .section-header h3 i {
        margin-right: 8px;
        color: var(--primary-color);
    }
    
    .calibration-card {
        background-color: var(--bg-color-light);
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
        overflow: hidden;
        box-shadow: var(--card-shadow);
        height: 100%;
    }
    
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md);
        background-color: var(--bg-color-lighter);
        border-bottom: 1px solid var(--border-color);
    }
    
    .card-header h4 {
        margin: 0;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .card-header h4 i {
        color: var(--primary-color);
    }
    
    .current-reading {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        background-color: var(--bg-color);
        padding: 4px 10px;
        border-radius: var(--border-radius);
    }
    
    .current-reading .label {
        font-weight: 500;
        margin-right: 6px;
    }
    
    .card-body {
        padding: var(--spacing-md);
    }
    
    .calibration-form {
        margin-bottom: var(--spacing-md);
    }
    
    .form-group {
        margin-bottom: var(--spacing-md);
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }
    
    .form-actions {
        margin-top: var(--spacing-md);
    }
    
    .calibration-instructions {
        margin-top: var(--spacing-md);
        padding: var(--spacing-sm);
        background-color: var(--bg-color);
        border-radius: var(--border-radius);
        font-size: 0.9rem;
    }
    
    .calibration-instructions p {
        margin: 0;
    }
    
    /* Refresh button */
    .refresh-btn {
        background: transparent;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        font-size: 1rem;
        padding: 5px;
        border-radius: 50%;
        transition: transform 0.3s ease;
    }
    
    .refresh-btn:hover {
        background-color: rgba(var(--primary-color-rgb), 0.1);
    }
    
    .refresh-btn.rotating {
        animation: rotate 0.5s linear;
    }
    
    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-sm);
        }
        
        .card-header {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-sm);
        }
        
        .current-reading {
            margin-top: var(--spacing-xs);
            width: 100%;
            justify-content: space-between;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Function to update current readings
        function updateReadings() {
            const refreshBtn = document.getElementById('refresh-readings');
            if (refreshBtn) {
                refreshBtn.classList.add('rotating');
            }
            
            fetch('/api/sensors/read_now', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('current-ph').textContent = data.readings.ph ? data.readings.ph.toFixed(2) : '--';
                    document.getElementById('current-ec').textContent = data.readings.ec ? data.readings.ec.toFixed(0) + ' μS/cm' : '--';
                    document.getElementById('current-temp').textContent = data.readings.temp ? data.readings.temp.toFixed(1) + '°C' : '--';
                } else {
                    console.error('Error reading sensors:', data.error);
                }
                
                if (refreshBtn) {
                    setTimeout(() => {
                        refreshBtn.classList.remove('rotating');
                    }, 500);
                }
            })
            .catch(error => {
                console.error('Error fetching sensor data:', error);
                if (refreshBtn) {
                    refreshBtn.classList.remove('rotating');
                }
            });
        }
        
        // Update readings on page load
        updateReadings();
        
        // Set up refresh button
        const refreshButton = document.getElementById('refresh-readings');
        if (refreshButton) {
            refreshButton.addEventListener('click', function() {
                updateReadings();
            });
        }
        
        // Set up interval refresh
        setInterval(updateReadings, 30000); // Every 30 seconds
    });
</script>
{% endblock %} 