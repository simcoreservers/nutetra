{% extends "base.html" %}

{% block title %}Sensors | NuTetra Controller{% endblock %}
{% block page_title %}Sensor Management{% endblock %}

{% block content %}
<div class="page-content">
    <div class="dashboard-section">
        <div class="section-header">
            <h3>Sensor Management</h3>
            <a href="{{ url_for('sensors.history') }}" class="view-all-link">View History</a>
        </div>

        <div class="readings-grid">
            <!-- pH Sensor Card -->
            <div class="reading-card sensor-card {% if get_sensor_status('ph') != 'connected' %}alert{% endif %}">
                <div class="reading-icon">
                    <i class="fas fa-tint"></i>
                </div>
                <div class="reading-details">
                    <h4>pH Sensor</h4>
                    <div class="sensor-status">
                        <span class="status-indicator {% if get_sensor_status('ph') == 'connected' %}success{% else %}danger{% endif %}"></span>
                        <span class="status-text">{{ get_sensor_status('ph')|title }}</span>
                    </div>
                    
                    {% set ph_reading = get_last_reading('ph') %}
                    <div class="reading-value" id="ph-value">{{ ph_reading|ph }}</div>
                    <div class="reading-range">
                        Target: {{ settings.get('ph_target_min', 5.8)|ph }} - {{ settings.get('ph_target_max', 6.2)|ph }}
                    </div>
                    
                    <div class="action-buttons">
                        <a href="{{ url_for('sensors.calibration') }}" class="action-button">Calibrate</a>
                    </div>
                </div>
            </div>
            
            <!-- EC Sensor Card -->
            <div class="reading-card sensor-card {% if get_sensor_status('ec') != 'connected' %}alert{% endif %}">
                <div class="reading-icon">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="reading-details">
                    <h4>EC Sensor</h4>
                    <div class="sensor-status">
                        <span class="status-indicator {% if get_sensor_status('ec') == 'connected' %}success{% else %}danger{% endif %}"></span>
                        <span class="status-text">{{ get_sensor_status('ec')|title }}</span>
                    </div>
                    
                    {% set ec_reading = get_last_reading('ec') %}
                    <div class="reading-value" id="ec-value">{{ ec_reading|ec }}</div>
                    <div class="reading-range">
                        Target: {{ settings.get('ec_target_min', 1.2)|ec }} - {{ settings.get('ec_target_max', 1.5)|ec }}
                    </div>
                    
                    <div class="action-buttons">
                        <a href="{{ url_for('sensors.calibration') }}" class="action-button">Calibrate</a>
                    </div>
                </div>
            </div>
            
            <!-- Temperature Sensor Card -->
            <div class="reading-card sensor-card {% if get_sensor_status('temp') != 'connected' %}alert{% endif %}">
                <div class="reading-icon">
                    <i class="fas fa-thermometer-half"></i>
                </div>
                <div class="reading-details">
                    <h4>Temperature Sensor</h4>
                    <div class="sensor-status">
                        <span class="status-indicator {% if get_sensor_status('temp') == 'connected' %}success{% else %}danger{% endif %}"></span>
                        <span class="status-text">{{ get_sensor_status('temp')|title }}</span>
                    </div>
                    
                    {% set temp_reading = get_last_reading('temp') %}
                    <div class="reading-value" id="temp-value">{{ temp_reading|temp }}</div>
                    <div class="reading-range">
                        Target: {{ settings.get('temp_target_min', 18.0)|temp }} - {{ settings.get('temp_target_max', 24.0)|temp }}
                    </div>
                    
                    <div class="action-buttons">
                        <a href="{{ url_for('sensors.calibration') }}" class="action-button">Calibrate</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="dashboard-section">
        <div class="section-header">
            <h3>Sensor Settings</h3>
        </div>
        
        <form method="post" action="{{ url_for('api.update_settings') }}">
            <div class="settings-grid">
                <!-- pH Settings -->
                <div class="settings-column">
                    <h4>pH Settings</h4>
                    <div class="form-group">
                        <label for="ph_target_min">Target Minimum</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="ph_target_min" name="ph_target_min" 
                                   value="{{ settings.get('ph_target_min', 5.8) }}" step="0.1" min="0" max="14">
                            <span class="input-group-text">pH</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="ph_target_max">Target Maximum</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="ph_target_max" name="ph_target_max" 
                                   value="{{ settings.get('ph_target_max', 6.2) }}" step="0.1" min="0" max="14">
                            <span class="input-group-text">pH</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="ph_check_interval">Check Interval</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="ph_check_interval" name="ph_check_interval" 
                                   value="{{ settings.get('ph_check_interval', 300) }}" step="10" min="10">
                            <span class="input-group-text">sec</span>
                        </div>
                    </div>
                </div>
                
                <!-- EC Settings -->
                <div class="settings-column">
                    <h4>EC Settings</h4>
                    <div class="form-group">
                        <label for="ec_target_min">Target Minimum</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="ec_target_min" name="ec_target_min" 
                                   value="{{ settings.get('ec_target_min', 1200) }}" step="50" min="0">
                            <span class="input-group-text">μS/cm</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="ec_target_max">Target Maximum</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="ec_target_max" name="ec_target_max" 
                                   value="{{ settings.get('ec_target_max', 1500) }}" step="50" min="0">
                            <span class="input-group-text">μS/cm</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="ec_check_interval">Check Interval</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="ec_check_interval" name="ec_check_interval" 
                                   value="{{ settings.get('ec_check_interval', 300) }}" step="10" min="10">
                            <span class="input-group-text">sec</span>
                        </div>
                    </div>
                </div>
                
                <!-- Temperature Settings -->
                <div class="settings-column">
                    <h4>Temperature Settings</h4>
                    <div class="form-group">
                        <label for="temp_target_min">Target Minimum</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="temp_target_min" name="temp_target_min" 
                                   value="{{ settings.get('temp_target_min', 18.0) }}" step="0.5" min="0">
                            <span class="input-group-text">°C</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="temp_target_max">Target Maximum</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="temp_target_max" name="temp_target_max" 
                                   value="{{ settings.get('temp_target_max', 24.0) }}" step="0.5" min="0">
                            <span class="input-group-text">°C</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="temp_check_interval">Check Interval</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="temp_check_interval" name="temp_check_interval" 
                                   value="{{ settings.get('temp_check_interval', 300) }}" step="10" min="10">
                            <span class="input-group-text">sec</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button type="submit" class="button">Save Settings</button>
            </div>
        </form>
    </div>
</div>

<!-- Meta tags for sensor settings -->
<meta name="refresh-interval" content="30">
<meta name="ph-settings" content='{"min": {{ settings.get("ph_target_min", 5.8) }}, "max": {{ settings.get("ph_target_max", 6.2) }}}'>
<meta name="ec-settings" content='{"min": {{ settings.get("ec_target_min", 1.2) }}, "max": {{ settings.get("ec_target_max", 1.5) }}}'>
<meta name="temp-settings" content='{"min": {{ settings.get("temp_target_min", 18.0) }}, "max": {{ settings.get("temp_target_max", 24.0) }}}'>
{% endblock %}

{% block extra_js %}
<script>
// Lightweight solution that won't freeze the browser
document.addEventListener('DOMContentLoaded', function() {
    // Apply CSS once and don't use continuous monitoring
    const sensorCards = document.querySelectorAll('.sensor-card, .reading-card');
    
    // One-time style application
    sensorCards.forEach(card => {
        // Use direct property assignment instead of setAttribute for better performance
        card.style.opacity = '1';
        card.style.visibility = 'visible';
        card.style.display = 'flex';
    });
    
    // Replace the original update function with a lightweight version if it exists
    if (typeof window.updateSensorDisplays === 'function') {
        const originalUpdate = window.updateSensorDisplays;
        
        window.updateSensorDisplays = function(data) {
            // Call the original function
            originalUpdate(data);
            
            // Just ensure values are updated but don't manipulate styles heavily
            if (data.ph !== null && data.ph !== undefined) {
                const phValue = document.getElementById('ph-value');
                if (phValue) phValue.textContent = parseFloat(data.ph).toFixed(2);
            }
            
            if (data.ec !== null && data.ec !== undefined) {
                const ecValue = document.getElementById('ec-value');
                if (ecValue) ecValue.textContent = parseFloat(data.ec).toFixed(2);
            }
            
            if (data.temp !== null && data.temp !== undefined) {
                const tempValue = document.getElementById('temp-value');
                if (tempValue) tempValue.textContent = parseFloat(data.temp).toFixed(1) + '°C';
            }
        };
    }
});
</script>
{% endblock %} 