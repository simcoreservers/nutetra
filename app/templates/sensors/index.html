{% extends "base.html" %}

{% block title %}Sensors | NuTetra Controller{% endblock %}
{% block page_title %}Sensor Management{% endblock %}

{% block content %}
<div class="page-content">
    <div class="dashboard-section">
        <div class="section-header">
            <h3>Sensor Management</h3>
            <a href="{{ url_for('sensors.history') }}" class="view-all-link">View History</a>
        </div>

        <div class="readings-grid">
            <!-- pH Sensor Card -->
            <div class="reading-card sensor-card {% if get_sensor_status('ph') != 'connected' %}alert{% endif %}">
                <div class="reading-icon">
                    <i class="fas fa-tint"></i>
                </div>
                <div class="reading-details">
                    <h4>pH Sensor</h4>
                    <div class="sensor-status">
                        <span class="status-indicator {% if get_sensor_status('ph') == 'connected' %}success{% else %}danger{% endif %}"></span>
                        <span class="status-text">{{ get_sensor_status('ph')|title }}</span>
                    </div>
                    
                    {% set ph_reading = get_last_reading('ph') %}
                    <div class="reading-value" id="ph-value">{{ ph_reading|ph }}</div>
                    <div class="reading-range">
                        Target: {{ (settings.get('ph_setpoint', 6.0) - settings.get('ph_buffer', 0.2))|ph }} - {{ (settings.get('ph_setpoint', 6.0) + settings.get('ph_buffer', 0.2))|ph }}
                    </div>
                    
                    <div class="action-buttons">
                        <a href="{{ url_for('sensors.calibration') }}" class="action-button">Calibrate</a>
                    </div>
                </div>
            </div>
            
            <!-- EC Sensor Card -->
            <div class="reading-card sensor-card {% if get_sensor_status('ec') != 'connected' %}alert{% endif %}">
                <div class="reading-icon">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="reading-details">
                    <h4>EC Sensor</h4>
                    <div class="sensor-status">
                        <span class="status-indicator {% if get_sensor_status('ec') == 'connected' %}success{% else %}danger{% endif %}"></span>
                        <span class="status-text">{{ get_sensor_status('ec')|title }}</span>
                    </div>
                    
                    {% set ec_reading = get_last_reading('ec') %}
                    <div class="reading-value" id="ec-value">{{ ec_reading|ec }}</div>
                    <div class="reading-range">
                        Target: {{ (settings.get('ec_setpoint', 1350) - settings.get('ec_buffer', 150))|ec }} - {{ (settings.get('ec_setpoint', 1350) + settings.get('ec_buffer', 150))|ec }}
                    </div>
                    
                    <div class="action-buttons">
                        <a href="{{ url_for('sensors.calibration') }}" class="action-button">Calibrate</a>
                    </div>
                </div>
            </div>
            
            <!-- Temperature Sensor Card -->
            <div class="reading-card sensor-card {% if get_sensor_status('temp') != 'connected' %}alert{% endif %}">
                <div class="reading-icon">
                    <i class="fas fa-thermometer-half"></i>
                </div>
                <div class="reading-details">
                    <h4>Temperature Sensor</h4>
                    <div class="sensor-status">
                        <span class="status-indicator {% if get_sensor_status('temp') == 'connected' %}success{% else %}danger{% endif %}"></span>
                        <span class="status-text">{{ get_sensor_status('temp')|title }}</span>
                    </div>
                    
                    {% set temp_reading = get_last_reading('temp') %}
                    <div class="reading-value" id="temp-value">{{ temp_reading|temp }}</div>
                    <div class="reading-range">
                        {% set profile = settings.get('plant_profiles', {}).get(settings.get('active_plant_profile', 'general'), {}) %}
                        {% if profile %}
                            Target: {{ profile.get('temp_min', 18.0) }} - {{ profile.get('temp_max', 28.0) }}째C
                        {% else %}
                            Alert: < {{ settings.get('temp_min_alert', 18.0) }}째C or > {{ settings.get('temp_max_alert', 30.0) }}째C
                        {% endif %}
                    </div>
                    
                    <div class="action-buttons">
                        <a href="{{ url_for('sensors.calibration') }}" class="action-button">Calibrate</a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Plant Profile Information -->
        <div class="profile-section">
            <div class="section-header">
                <h4>Active Plant Profile: {{ settings.get('plant_profiles', {}).get(settings.get('active_plant_profile', 'general'), {}).get('name', 'General Purpose') }}</h4>
                <a href="{{ url_for('dosing.settings') }}" class="action-button small">Change Profile</a>
            </div>
            
            <div class="profile-description">
                {{ settings.get('plant_profiles', {}).get(settings.get('active_plant_profile', 'general'), {}).get('description', 'Default settings for general hydroponics') }}
            </div>
        </div>
    </div>
</div>

<!-- Meta tags for sensor settings -->
<meta name="refresh-interval" content="30">
<meta name="ph-settings" content='{"setpoint": {{ settings.get("ph_setpoint", 6.0) }}, "buffer": {{ settings.get("ph_buffer", 0.2) }}}'>
<meta name="ec-settings" content='{"setpoint": {{ settings.get("ec_setpoint", 1350) }}, "buffer": {{ settings.get("ec_buffer", 150) }}}'>
<meta name="temp-settings" content='{"min": {{ settings.get("plant_profiles", {}).get(settings.get("active_plant_profile", "general"), {}).get("temp_min", 18.0) }}, "max": {{ settings.get("plant_profiles", {}).get(settings.get("active_plant_profile", "general"), {}).get("temp_max", 28.0) }}}'>
{% endblock %}

{% block extra_css %}
<style>
    .profile-section {
        margin-top: var(--spacing-md);
        padding: var(--spacing-md);
        background-color: var(--bg-color-lighter);
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
    }
    
    .profile-section .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .profile-section h4 {
        margin: 0;
        font-size: 1.1rem;
    }
    
    .action-button.small {
        padding: 4px 8px;
        font-size: 0.85rem;
    }
    
    .profile-description {
        margin-top: var(--spacing-sm);
        font-size: 0.9rem;
        color: var(--text-color-muted);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Lightweight solution that won't freeze the browser
document.addEventListener('DOMContentLoaded', function() {
    // Apply CSS once and don't use continuous monitoring
    const sensorCards = document.querySelectorAll('.sensor-card, .reading-card');
    
    // One-time style application
    sensorCards.forEach(card => {
        // Use direct property assignment instead of setAttribute for better performance
        card.style.opacity = '1';
        card.style.visibility = 'visible';
        card.style.display = 'flex';
    });
    
    // Replace the original update function with a lightweight version if it exists
    if (typeof window.updateSensorDisplays === 'function') {
        const originalUpdate = window.updateSensorDisplays;
        
        window.updateSensorDisplays = function(data) {
            // Call the original function
            originalUpdate(data);
            
            // Just ensure values are updated but don't manipulate styles heavily
            if (data.ph !== null && data.ph !== undefined) {
                const phValue = document.getElementById('ph-value');
                if (phValue) phValue.textContent = parseFloat(data.ph).toFixed(2);
            }
            
            if (data.ec !== null && data.ec !== undefined) {
                const ecValue = document.getElementById('ec-value');
                if (ecValue) ecValue.textContent = parseFloat(data.ec).toFixed(2);
            }
            
            if (data.temp !== null && data.temp !== undefined) {
                const tempValue = document.getElementById('temp-value');
                if (tempValue) tempValue.textContent = parseFloat(data.temp).toFixed(1) + '째C';
            }
        };
    }
});
</script>
{% endblock %} 